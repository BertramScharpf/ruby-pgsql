#!/usr/bin/ruby

#
#  pgbackup.rb  --  database backup
#


require "pgsql"

class Backup < Pg::Conn

  # This was successfully tested with:
  ARCHIVE_COMMAND =
    "rsync -ar %p rsync://backupserver/backupdir/pg-myhost/XLOG/%f"
  # XLOG must exist in the backup directory. No error will be reported.

  class <<self
    def open *args
      b = new *args
      begin
        yield b
      ensure
        b.finish
      end
    end
    def run *args
      open *args do |b| b.run end
    end
  end

  def initialize *args
    super *args
    exec "select pg_start_backup('pgsql-auto');"
  end

  def close
    exec "select pg_stop_backup();"
    super
  end
  alias finish close

  def run
    arch_cmd, = select_one "show archive_command;"
    datadir,  = select_one "show data_directory;"
    tblsp = query <<-ENDSQL
      select spcname, spclocation from pg_tablespace
        where length(spclocation)>0
    ENDSQL
    [ ["@CLUSTER", datadir], *tblsp].each { |(nam,dir)|
      # We rely on the fact that Postgresql removed all trailing slashes.
      a = arch_cmd.gsub /%(.)/ do
        case $1
          when "p" then dir
          when "f" then ""
          when "%" then "%"
        end
      end
      a.gsub! /\bXLOG\b/, nam
      system a
      raise RuntimeError, "#{a} => #$?" unless $?.success?
    }
  end

end

Backup.run *$*

